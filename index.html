<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ config.sailboatName }} - Sailing Performance Dashboard</title>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', system-ui, -apple-system, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 1rem;
            position: relative;
            overflow-x: hidden;
        }

        body.custom-background {
            background-size: cover;
            background-position: center;
            background-attachment: fixed;
        }

        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-image: 
                radial-gradient(circle at 20% 80%, rgba(120, 119, 198, 0.3) 0%, transparent 50%),
                radial-gradient(circle at 80% 20%, rgba(255, 255, 255, 0.1) 0%, transparent 50%),
                radial-gradient(circle at 40% 40%, rgba(120, 119, 198, 0.2) 0%, transparent 50%);
            pointer-events: none;
            z-index: -1;
        }

        body.custom-background::before {
            background: rgba(0, 0, 0, 0.4);
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        .header {
            text-align: center;
            margin-bottom: 2rem;
        }

        .header h1 {
            color: white;
            font-size: 2.5rem;
            font-weight: 700;
            margin-bottom: 0.5rem;
            text-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .header p {
            color: rgba(255, 255, 255, 0.8);
            font-size: 1.1rem;
        }

        .glass-card {
            background: rgba(255, 255, 255, 0.12);
            backdrop-filter: blur(20px);
            border-radius: 20px;
            border: 1px solid rgba(255, 255, 255, 0.15);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .glass-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 1px;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.4), transparent);
        }

        .glass-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 12px 40px rgba(0, 0, 0, 0.15);
            border-color: rgba(255, 255, 255, 0.25);
        }

        .upload-card {
            text-align: center;
        }

        .upload-area {
            border: 2px dashed rgba(255, 255, 255, 0.3);
            border-radius: 15px;
            padding: 2rem;
            margin: 1rem 0;
            cursor: pointer;
            transition: all 0.3s ease;
            background: rgba(255, 255, 255, 0.05);
        }

        .upload-area:hover {
            border-color: rgba(255, 255, 255, 0.5);
            background: rgba(255, 255, 255, 0.08);
        }

        .upload-area.dragover {
            border-color: #4facfe;
            background: rgba(79, 172, 254, 0.1);
        }

        .upload-icon {
            font-size: 1.2rem;
            color: rgba(255, 255, 255, 0.6);
            margin-bottom: 1rem;
            font-weight: bold;
        }

        .upload-text {
            color: white;
            font-size: 1.1rem;
            margin-bottom: 0.5rem;
        }

        .upload-hint {
            color: rgba(255, 255, 255, 0.6);
            font-size: 0.9rem;
        }

        .file-input {
            display: none;
        }

        .metrics-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 1.5rem;
        }

        @media (min-width: 768px) {
            .metrics-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        @media (min-width: 1024px) {
            .metrics-grid {
                grid-template-columns: repeat(4, 1fr);
            }
        }

        .metric-card {
            text-align: center;
            position: relative;
        }

        .metric-title {
            color: rgba(255, 255, 255, 0.8);
            font-size: 0.9rem;
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 1rem;
        }

        .metric-value {
            color: white;
            font-size: 3rem;
            font-weight: 700;
            margin-bottom: 0.5rem;
            text-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .metric-unit {
            color: rgba(255, 255, 255, 0.6);
            font-size: 1.5rem;
            font-weight: 400;
        }

        .metric-description {
            color: rgba(255, 255, 255, 0.7);
            font-size: 0.8rem;
            margin-top: 0.5rem;
            line-height: 1.3;
        }

        .liquid-bubble {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 120px;
            height: 120px;
        }

        .bubble-container {
            width: 100%;
            height: 100%;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.1);
            border: 2px solid rgba(255, 255, 255, 0.3);
            overflow: hidden;
            position: relative;
            box-shadow: 
                inset 0 0 20px rgba(255, 255, 255, 0.1),
                0 0 20px rgba(0, 0, 0, 0.1);
        }

        .liquid-fill {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 0%;
            background: linear-gradient(180deg, 
                rgba(79, 172, 254, 0.9) 0%,
                rgba(79, 172, 254, 0.7) 50%,
                rgba(79, 172, 254, 0.9) 100%
            );
            transition: height 2s cubic-bezier(0.25, 0.46, 0.45, 0.94);
            overflow: hidden;
            opacity: 0;
        }

        .liquid-fill.animate {
            opacity: 1;
            transition: height 2s cubic-bezier(0.25, 0.46, 0.45, 0.94), 
                       opacity 0.5s ease-in-out;
        }

        .wave {
            position: absolute;
            top: -10px;
            left: -50%;
            width: 200%;
            height: 20px;
            background: linear-gradient(90deg,
                transparent 0%,
                rgba(255, 255, 255, 0.3) 25%,
                transparent 50%,
                rgba(255, 255, 255, 0.3) 75%,
                transparent 100%
            );
            border-radius: 50%;
            animation: wave 3s ease-in-out infinite;
        }

        .wave:nth-child(2) {
            animation-delay: -1s;
            opacity: 0.7;
            height: 15px;
        }

        .wave:nth-child(3) {
            animation-delay: -2s;
            opacity: 0.5;
            height: 12px;
        }

        @keyframes wave {
            0%, 100% {
                transform: translateX(0) rotate(0deg);
            }
            50% {
                transform: translateX(-25%) rotate(180deg);
            }
        }

        .bubble-glow {
            position: absolute;
            top: 15%;
            left: 15%;
            width: 30%;
            height: 30%;
            background: radial-gradient(circle, rgba(255, 255, 255, 0.4) 0%, transparent 70%);
            border-radius: 50%;
            animation: glow 2s ease-in-out infinite alternate;
        }

        @keyframes glow {
            0% { opacity: 0.6; transform: scale(1); }
            100% { opacity: 1; transform: scale(1.1); }
        }

        .liquid-fill.excellent {
            background: linear-gradient(180deg, 
                rgba(81, 207, 102, 0.9) 0%,
                rgba(81, 207, 102, 0.7) 50%,
                rgba(81, 207, 102, 0.9) 100%
            );
        }

        .liquid-fill.good {
            background: linear-gradient(180deg, 
                rgba(255, 212, 59, 0.9) 0%,
                rgba(255, 212, 59, 0.7) 50%,
                rgba(255, 212, 59, 0.9) 100%
            );
        }

        .liquid-fill.fair {
            background: linear-gradient(180deg, 
                rgba(255, 140, 66, 0.9) 0%,
                rgba(255, 140, 66, 0.7) 50%,
                rgba(255, 140, 66, 0.9) 100%
            );
        }

        .liquid-fill.poor {
            background: linear-gradient(180deg, 
                rgba(255, 107, 107, 0.9) 0%,
                rgba(255, 107, 107, 0.7) 50%,
                rgba(255, 107, 107, 0.9) 100%
            );
        }

        .data-summary {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-top: 1rem;
        }

        .summary-item {
            background: rgba(255, 255, 255, 0.08);
            padding: 1rem;
            border-radius: 12px;
            text-align: center;
        }

        .summary-label {
            color: rgba(255, 255, 255, 0.7);
            font-size: 0.8rem;
            margin-bottom: 0.5rem;
        }

        .summary-value {
            color: white;
            font-size: 1.2rem;
            font-weight: 600;
        }

        .error-message, .loading-message {
            color: white;
            text-align: center;
            padding: 1rem;
            border-radius: 10px;
            margin: 1rem 0;
        }

        .error-message {
            background: rgba(255, 107, 107, 0.2);
            border: 1px solid rgba(255, 107, 107, 0.3);
        }

        .loading-message {
            background: rgba(79, 172, 254, 0.2);
            border: 1px solid rgba(79, 172, 254, 0.3);
        }

        .loading-spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 2px solid rgba(255,255,255,0.3);
            border-radius: 50%;
            border-top-color: white;
            animation: spin 1s ease-in-out infinite;
            margin-right: 0.5rem;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .hidden {
            display: none;
        }

        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 1000;
        }

        .modal input {
            box-sizing: border-box;
        }

        .modal input:focus {
            outline: none;
            border-color: rgba(79, 172, 254, 0.6);
            box-shadow: 0 0 0 2px rgba(79, 172, 254, 0.2);
        }

        .modal button:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
        }

        .btn {
            background: rgba(79, 172, 254, 0.8);
            border: 1px solid rgba(79, 172, 254, 0.3);
            padding: 0.5rem 1rem;
            border-radius: 20px;
            color: white;
            cursor: pointer;
            backdrop-filter: blur(10px);
            transition: all 0.3s ease;
            font-size: 0.8rem;
        }

        .btn:hover {
            background: rgba(79, 172, 254, 1);
            transform: translateY(-1px);
        }

        .btn-secondary {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.3);
        }

        .btn-secondary:hover {
            background: rgba(255, 255, 255, 0.15);
            border-color: rgba(255, 255, 255, 0.4);
        }

        .race-mini-card {
            background: rgba(255, 255, 255, 0.08);
            padding: 0.75rem;
            border-radius: 8px;
            text-align: center;
            transition: all 0.3s ease;
            border: 1px solid transparent;
            position: relative;
            perspective: 1000px;
            min-height: 80px;
            cursor: pointer;
            transform-style: preserve-3d;
        }

        .latest-race-card {
            background: rgba(255, 255, 255, 0.05) !important;
            border: 1px solid rgba(255, 255, 255, 0.15);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        }

        .race-mini-card:hover {
            background: rgba(255, 255, 255, 0.12);
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
        }

        .race-card-inner {
            position: relative;
            width: 100%;
            height: 100%;
            text-align: center;
            transition: transform 0.6s;
            transform-style: preserve-3d;
            min-height: 80px;
        }

        .race-mini-card.flipped .race-card-inner {
            transform: rotateY(180deg);
        }

        .race-card-front, .race-card-back {
            position: absolute;
            width: 100%;
            height: 100%;
            backface-visibility: hidden;
            border-radius: 8px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            min-height: 80px;
        }

        .race-card-back {
            transform: rotateY(180deg);
            background: rgba(255, 255, 255, 0.12);
            backdrop-filter: blur(20px);
            padding: 0.5rem;
            overflow-y: auto;
            max-height: 300px;
        }

        .race-results-header {
            color: white;
            font-size: 0.7rem;
            font-weight: bold;
            margin-bottom: 0.5rem;
            padding-bottom: 0.25rem;
            border-bottom: 1px solid rgba(255, 255, 255, 0.2);
        }

        .race-result-row {
            display: grid;
            grid-template-columns: 0.8fr 2fr 1.2fr 1.2fr 1fr;
            gap: 0.25rem;
            margin-bottom: 0.25rem;
            padding: 0.25rem;
            border-radius: 4px;
            font-size: 0.65rem;
            align-items: center;
            transition: all 0.2s ease;
        }

        .race-result-row:hover {
            background: rgba(255, 255, 255, 0.1);
        }

        .race-result-row.boat-highlight {
            background: rgba(79, 172, 254, 0.2);
            border: 1px solid rgba(79, 172, 254, 0.4);
        }

        .position-cell {
            color: white;
            font-weight: bold;
            text-align: center;
        }

        .boat-name-cell {
            color: white;
            font-weight: 600;
            text-align: left;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .time-cell {
            color: rgba(255, 255, 255, 0.8);
            text-align: center;
            font-family: monospace;
        }

        .delta-cell {
            color: rgba(255, 255, 255, 0.7);
            text-align: center;
            font-family: monospace;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.6; transform: scale(0.8); }
        }

        .notification-bar {
            background: rgba(79, 172, 254, 0.2);
            border: 1px solid rgba(79, 172, 254, 0.4);
            border-radius: 10px;
            padding: 0.75rem;
            margin-bottom: 1rem;
            text-align: center;
        }

        @media (max-width: 767px) {
            body {
                padding: 0.5rem;
            }
            
            .header h1 {
                font-size: 2rem;
            }
            
            .metric-value {
                font-size: 2.5rem;
            }
            
            .glass-card {
                padding: 1rem;
            }
        }
    </style>
</head>
<body :class="{ 'custom-background': config.backgroundImage }">
    <div id="app">
        <div class="container">
            <!-- Header -->
            <div class="header">
                <h1>{{ config.sailboatName }}</h1>
                <p>Real-time performance dashboard for {{ config.sailboatName }}</p>
            </div>

            <!-- Login & Configuration Card -->
            <login-config-card 
                :login-state="loginState"
                :config="config"
                @show-login-modal="showLoginModal"
                @logout="logout"
                @save-quick-config="saveQuickConfig"
                @show-config-modal="showConfigModal">
            </login-config-card>

            <!-- Racing Results Card -->
            <racing-results-card 
                :config="config"
                :race-data="raceData"
                :last-update-time="lastUpdateTime"
                @manual-refresh="manualRefreshResults">
            </racing-results-card>

            <!-- File Upload Card -->
            <file-upload-card 
                :is-loading="isLoading"
                :error-message="errorMessage"
                @file-uploaded="handleFileUpload"
                @show-api-config="showApiConfig">
            </file-upload-card>

            <!-- Data Preview -->
            <data-preview-card 
                v-if="data.length > 0"
                :data="data">
            </data-preview-card>

            <!-- Metrics Container -->
            <metrics-container 
                v-if="metrics"
                :metrics="metrics">
            </metrics-container>

            <!-- Login Modal -->
            <login-modal 
                v-if="modals.showLogin"
                @close="closeLoginModal"
                @login="attemptLogin">
            </login-modal>

            <!-- Config Modal -->
            <config-modal 
                v-if="modals.showConfig"
                :config="config"
                @close="closeConfigModal"
                @save="saveConfiguration"
                @reset-background="resetBackground">
            </config-modal>

            <!-- API Config Modal -->
            <api-config-modal 
                v-if="modals.showApiConfig"
                @close="closeApiConfig">
            </api-config-modal>
        </div>
    </div>

    <script>
        const { createApp } = Vue;

        // Login Configuration Card Component
        const LoginConfigCard = {
            props: ['loginState', 'config'],
            emits: ['showLoginModal', 'logout', 'saveQuickConfig', 'showConfigModal'],
            data() {
                return {
                    quickBoatName: '',
                    quickBoatClass: ''
                };
            },
            watch: {
                config: {
                    handler(newConfig) {
                        this.quickBoatName = newConfig.sailboatName;
                        this.quickBoatClass = newConfig.boatClass;
                    },
                    immediate: true
                }
            },
            template: `
                <div class="glass-card" style="margin-bottom: 1rem;">
                    <!-- Not Logged In State -->
                    <div v-if="!loginState.isLoggedIn">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <div>
                                <h3 style="color: white; margin: 0; font-size: 1rem;">Access Control</h3>
                                <p style="color: rgba(255,255,255,0.7); margin: 0.25rem 0 0 0; font-size: 0.85rem;">
                                    Login required to configure sailboat settings
                                </p>
                            </div>
                            <button @click="$emit('showLoginModal')" class="btn">Login</button>
                        </div>
                    </div>

                    <!-- Logged In State -->
                    <div v-else>
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
                            <div>
                                <h3 style="color: white; margin: 0; font-size: 1rem;">Sailboat Configuration</h3>
                                <p style="color: rgba(255,255,255,0.7); margin: 0.25rem 0 0 0; font-size: 0.85rem;">
                                    Logged in as <span>{{ loginState.username }}</span>
                                </p>
                            </div>
                            <button @click="$emit('logout')" class="btn btn-secondary">Logout</button>
                        </div>

                        <!-- Quick Configuration Section -->
                        <div style="background: rgba(255,255,255,0.05); border-radius: 12px; padding: 1rem; margin-bottom: 1rem;">
                            <div style="display: grid; grid-template-columns: 2fr 2fr 1fr; gap: 1rem; align-items: end;">
                                <div>
                                    <label style="color: rgba(255,255,255,0.8); display: block; margin-bottom: 0.5rem; font-size: 0.8rem;">
                                        Boat Name
                                    </label>
                                    <input type="text" v-model="quickBoatName" placeholder="Enter boat name" style="
                                        width: 100%;
                                        padding: 0.6rem;
                                        border-radius: 8px;
                                        border: 1px solid rgba(255,255,255,0.3);
                                        background: rgba(255,255,255,0.1);
                                        color: white;
                                        backdrop-filter: blur(10px);
                                        font-size: 0.85rem;
                                    ">
                                </div>
                                <div>
                                    <label style="color: rgba(255,255,255,0.8); display: block; margin-bottom: 0.5rem; font-size: 0.8rem;">
                                        Boat Class
                                    </label>
                                    <input type="text" v-model="quickBoatClass" placeholder="e.g., ORC International" style="
                                        width: 100%;
                                        padding: 0.6rem;
                                        border-radius: 8px;
                                        border: 1px solid rgba(255,255,255,0.3);
                                        background: rgba(255,255,255,0.1);
                                        color: white;
                                        backdrop-filter: blur(10px);
                                        font-size: 0.85rem;
                                    ">
                                </div>
                                <div>
                                    <button @click="saveQuick" style="
                                        background: rgba(81, 207, 102, 0.8);
                                        border: none;
                                        padding: 0.6rem 1rem;
                                        border-radius: 8px;
                                        color: white;
                                        cursor: pointer;
                                        font-size: 0.8rem;
                                        width: 100%;
                                    ">Update</button>
                                </div>
                            </div>
                        </div>

                        <!-- Current Configuration Display -->
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <div>
                                <div style="color: rgba(255,255,255,0.6); font-size: 0.75rem; margin-bottom: 0.25rem;">Current Configuration:</div>
                                <div style="color: white; font-weight: 600;">
                                    {{ config.sailboatName }} • {{ config.boatClass }}
                                </div>
                            </div>
                            <button @click="$emit('showConfigModal')" class="btn btn-secondary">Advanced Settings</button>
                        </div>
                    </div>
                </div>
            `,
            methods: {
                saveQuick() {
                    this.$emit('saveQuickConfig', {
                        sailboatName: this.quickBoatName.trim().toUpperCase(),
                        boatClass: this.quickBoatClass.trim()
                    });
                }
            }
        };

        // Racing Results Card Component
        const RacingResultsCard = {
            props: ['config', 'raceData', 'lastUpdateTime'],
            emits: ['manualRefresh'],
            data() {
                return {
                    flippedCards: new Set()
                };
            },
            template: `
                <div class="glass-card">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                        <div>
                            <h3 style="color: white; margin: 0; font-size: 1.3rem;">Andros 2025</h3>
                            <p style="color: rgba(255,255,255,0.7); margin: 0.25rem 0 0 0; font-size: 0.9rem;">
                                {{ config.sailboatName }} • Greek Islands • August 28-31, 2025
                            </p>
                        </div>
                        <div style="display: flex; align-items: center; gap: 1rem;">
                            <div style="text-align: right;">
                                <div style="color: rgba(255,255,255,0.5); font-size: 0.7rem;">Last Update</div>
                                <div style="color: rgba(255,255,255,0.8); font-size: 0.8rem;">{{ lastUpdateTime }}</div>
                            </div>
                            <div style="display: flex; align-items: center; gap: 0.5rem;">
                                <div style="
                                    width: 8px; 
                                    height: 8px; 
                                    border-radius: 50%; 
                                    background: rgba(81, 207, 102, 0.8);
                                    animation: pulse 2s infinite;
                                "></div>
                                <span style="color: rgba(255,255,255,0.6); font-size: 0.8rem;">Live</span>
                            </div>
                            <button @click="$emit('manualRefresh')" class="btn">Refresh</button>
                        </div>
                    </div>

                    <!-- Latest Race Result -->
                    <div style="margin-bottom: 1rem;">
                        <h4 style="color: rgba(255,255,255,0.8); font-size: 0.9rem; margin-bottom: 0.75rem; text-transform: uppercase; letter-spacing: 1px; display: flex; align-items: center; gap: 0.5rem;">
                            Latest Race - Chios to Andros
                            <span style="color: rgba(255,255,255,0.5); font-size: 0.7rem; font-weight: normal; background: rgba(255,255,255,0.1); padding: 0.2rem 0.5rem; border-radius: 10px;">
                                {{ raceData.overallStanding.status }}
                            </span>
                        </h4>
                        <div 
                            class="race-mini-card latest-race-card" 
                            :class="{ flipped: flippedCards.has('latest') }"
                            @click="toggleFlip('latest')"
                            style="min-height: 120px; padding: 0;">
                            <div class="race-card-inner">
                                <!-- Front Side -->
                                <div class="race-card-front" style="background: rgba(255,255,255,0.05); border-radius: 12px; padding: 1rem;">
                                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.75rem;">
                                        <span style="color: white; font-weight: 600; font-size: 1.1rem;">Chios to Andros</span>
                                        <span style="color: rgba(255,255,255,0.7); font-size: 0.8rem;">Pending</span>
                                    </div>
                                    <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 0.75rem; text-align: center; margin-bottom: 0.5rem;">
                                        <div>
                                            <div style="color: rgba(255,255,255,0.6); font-size: 0.75rem;">Position</div>
                                            <div style="color: white; font-size: 1.3rem; font-weight: 700;">TBD</div>
                                        </div>
                                        <div>
                                            <div style="color: rgba(255,255,255,0.6); font-size: 0.75rem;">Finish Time</div>
                                            <div style="color: white; font-size: 0.85rem; font-weight: 600; font-family: monospace;">TBD</div>
                                        </div>
                                        <div>
                                            <div style="color: rgba(255,255,255,0.6); font-size: 0.75rem;">To 1st</div>
                                            <div style="color: rgba(255, 140, 66, 0.9); font-size: 0.85rem; font-weight: 600;">TBD</div>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Back Side -->
                                <div class="race-card-back">
                                    <div style="text-align: center; padding: 2rem; color: rgba(255,255,255,0.6);">
                                        <div style="font-size: 1.2rem; margin-bottom: 1rem;">⛵</div>
                                        <div style="font-size: 0.9rem; margin-bottom: 0.5rem;">Chios to Andros</div>
                                        <div style="font-size: 0.75rem; line-height: 1.4;">
                                            Results will be posted on<br>
                                            <a href="https://data.orc.org/public/WEV.dll?action=index&eventid=andros2025" 
                                               target="_blank" 
                                               style="color: rgba(79, 172, 254, 0.8); text-decoration: none;">
                                                ORC Event Website
                                            </a>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Series Results Overall -->
                    <div style="margin-bottom: 1rem;">
                        <h4 style="color: rgba(255,255,255,0.8); font-size: 0.9rem; margin-bottom: 0.75rem; text-transform: uppercase; letter-spacing: 1px; display: flex; align-items: center; gap: 0.5rem;">
                            Series Results Overall - Andros 2025
                            <span style="color: rgba(255,255,255,0.5); font-size: 0.7rem; font-weight: normal; background: rgba(255,255,255,0.1); padding: 0.2rem 0.5rem; border-radius: 10px;">
                                Event pending
                            </span>
                        </h4>
                        <div 
                            class="race-mini-card series-card" 
                            :class="{ flipped: flippedCards.has('series') }"
                            @click="toggleFlip('series')"
                            style="min-height: 120px; padding: 0;">
                            <div class="race-card-inner">
                                <!-- Front Side -->
                                <div class="race-card-front" style="background: rgba(255,255,255,0.05); border-radius: 12px; padding: 1rem;">
                                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.75rem;">
                                        <span style="color: white; font-weight: 600; font-size: 1.1rem;">{{ raceData.overallStanding.className }}</span>
                                        <span style="color: rgba(255,255,255,0.7); font-size: 0.8rem;">{{ raceData.overallStanding.completedRaces }} races</span>
                                    </div>
                                    <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 0.75rem; text-align: center;">
                                        <div>
                                            <div style="color: rgba(255,255,255,0.6); font-size: 0.75rem;">Position</div>
                                            <div style="color: white; font-size: 1.3rem; font-weight: 700;">{{ raceData.overallStanding.position || 'TBD' }}</div>
                                        </div>
                                        <div>
                                            <div style="color: rgba(255,255,255,0.6); font-size: 0.75rem;">Total Points</div>
                                            <div style="color: white; font-size: 1.3rem; font-weight: 700;">{{ raceData.overallStanding.totalPoints }}</div>
                                        </div>
                                        <div>
                                            <div style="color: rgba(255,255,255,0.6); font-size: 0.75rem;">Net Points</div>
                                            <div style="color: white; font-size: 1.3rem; font-weight: 700;">{{ raceData.overallStanding.netPoints }}</div>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Back Side -->
                                <div class="race-card-back">
                                    <div style="text-align: center; padding: 2rem; color: rgba(255,255,255,0.6);">
                                        <div style="font-size: 1.2rem; margin-bottom: 1rem;">⛵</div>
                                        <div style="font-size: 0.9rem; margin-bottom: 0.5rem;">Event Pending</div>
                                        <div style="font-size: 0.75rem; line-height: 1.4;">
                                            Results will appear here once the<br>Chios to Andros race begins
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Race History -->
                    <div style="margin-top: 1rem;">
                        <h4 style="color: rgba(255,255,255,0.8); font-size: 0.9rem; margin-bottom: 0.75rem; text-transform: uppercase; letter-spacing: 1px; display: flex; align-items: center; gap: 0.5rem;">
                            Race Result Details
                            <span style="color: rgba(255,255,255,0.5); font-size: 0.7rem; font-weight: normal; background: rgba(255,255,255,0.1); padding: 0.2rem 0.5rem; border-radius: 10px;">
                                Click to flip cards
                            </span>
                        </h4>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(100px, 1fr)); gap: 0.75rem;">
                            <div class="race-mini-card upcoming" style="border: 1px dashed rgba(79, 172, 254, 0.4); background: rgba(79, 172, 254, 0.05); cursor: default; min-height: 80px; padding: 1rem;">
                                <div style="text-align: center; color: rgba(255,255,255,0.7);">
                                    <div style="font-weight: 600; margin-bottom: 0.5rem;">Chios to Andros</div>
                                    <div style="color: rgba(79, 172, 254, 0.9); font-weight: 600; margin-bottom: 0.5rem;">Upcoming</div>
                                    <div style="font-size: 0.7rem; color: rgba(255,255,255,0.5);">August 2025</div>
                                    <div style="font-size: 0.65rem; color: rgba(255,255,255,0.5); margin-top: 0.25rem;">
                                        Check <a href="https://data.orc.org/public/WEV.dll?action=index&eventid=andros2025" 
                                                target="_blank" 
                                                style="color: rgba(79, 172, 254, 0.8); text-decoration: none;">ORC</a> for updates
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div style="margin-top: 1rem; text-align: center; display: flex; justify-content: space-between; align-items: center;">
                        <span style="color: rgba(255,255,255,0.5); font-size: 0.8rem;">
                            Last updated: {{ lastUpdateTime }}
                        </span>
                        <a href="https://data.orc.org/public/WEV.dll?action=index&eventid=andros2025" 
                           target="_blank" 
                           class="btn btn-secondary">Andros 2025 Results on ORC</a>
                    </div>
                </div>
            `,
            methods: {
                toggleFlip(cardId) {
                    if (this.flippedCards.has(cardId)) {
                        this.flippedCards.delete(cardId);
                    } else {
                        this.flippedCards.add(cardId);
                    }
                    // Vue reactivity trigger
                    this.flippedCards = new Set(this.flippedCards);
                }
            }
        };

        // File Upload Card Component
        const FileUploadCard = {
            props: ['isLoading', 'errorMessage'],
            emits: ['fileUploaded', 'showApiConfig'],
            data() {
                return {
                    isDragging: false
                };
            },
            template: `
                <div class="glass-card upload-card">
                    <div 
                        class="upload-area" 
                        :class="{ dragover: isDragging }"
                        @click="triggerFileInput"
                        @dragover.prevent="isDragging = true"
                        @dragleave="isDragging = false"
                        @drop.prevent="handleDrop">
                        <div class="upload-icon">📁</div>
                        <div class="upload-text">Upload Expedition Marine Log</div>
                        <div class="upload-hint">Click to select or drag & drop your log file</div>
                    </div>
                    <input 
                        ref="fileInput"
                        type="file" 
                        class="file-input" 
                        accept=".csv,.txt,.log"
                        @change="handleFileInput">
                    
                    <div style="margin: 1rem 0; text-align: center;">
                        <div style="color: rgba(255,255,255,0.6); margin: 0.5rem 0;">— or —</div>
                        <button @click="$emit('showApiConfig')" class="btn btn-secondary">
                            📊 Connect to WebReports
                        </button>
                    </div>
                    
                    <div v-if="isLoading" class="loading-message">
                        <div class="loading-spinner"></div>
                        Processing log data...
                    </div>
                    
                    <div v-if="errorMessage" class="error-message">
                        {{ errorMessage }}
                    </div>
                </div>
            `,
            methods: {
                triggerFileInput() {
                    this.$refs.fileInput.click();
                },
                handleFileInput(event) {
                    const file = event.target.files[0];
                    if (file) {
                        this.$emit('fileUploaded', file);
                    }
                },
                handleDrop(event) {
                    this.isDragging = false;
                    const files = event.dataTransfer.files;
                    if (files.length > 0) {
                        this.$emit('fileUploaded', files[0]);
                    }
                }
            }
        };

        // Data Preview Card Component
        const DataPreviewCard = {
            props: ['data'],
            computed: {
                totalRecords() {
                    return this.data.length;
                },
                avgWindSpeed() {
                    return (this.data.reduce((sum, r) => sum + r.trueWindSpeed, 0) / this.totalRecords).toFixed(1);
                },
                avgBoatSpeed() {
                    return (this.data.reduce((sum, r) => sum + r.boatSpeed, 0) / this.totalRecords).toFixed(1);
                },
                timeRange() {
                    const minutes = this.totalRecords;
                    return `${Math.floor(minutes / 60)}h ${minutes % 60}m`;
                }
            },
            template: `
                <div class="glass-card">
                    <h3 style="color: white; margin-bottom: 1rem;">📊 Data Summary</h3>
                    <div class="data-summary">
                        <div class="summary-item">
                            <div class="summary-label">Total Records</div>
                            <div class="summary-value">{{ totalRecords.toLocaleString() }}</div>
                        </div>
                        <div class="summary-item">
                            <div class="summary-label">Time Range</div>
                            <div class="summary-value">{{ timeRange }}</div>
                        </div>
                        <div class="summary-item">
                            <div class="summary-label">Avg Wind Speed</div>
                            <div class="summary-value">{{ avgWindSpeed }} kts</div>
                        </div>
                        <div class="summary-item">
                            <div class="summary-label">Avg Boat Speed</div>
                            <div class="summary-value">{{ avgBoatSpeed }} kts</div>
                        </div>
                    </div>
                </div>
            `
        };

        // Metrics Container Component
        const MetricsContainer = {
            props: ['metrics'],
            mounted() {
                this.setupIntersectionObserver();
            },
            template: `
                <div class="metrics-grid">
                    <metric-card 
                        title="Overall Efficiency"
                        :value="metrics.overallEfficiency"
                        unit="%"
                        description="Average performance vs polar"
                        metric-id="efficiency">
                    </metric-card>
                    
                    <metric-card 
                        title="VMG Upwind"
                        :value="metrics.vmgUpwind"
                        unit="%"
                        description="TWA < 60° performance"
                        metric-id="vmgUpwind">
                    </metric-card>
                    
                    <metric-card 
                        title="VMG Downwind"
                        :value="metrics.vmgDownwind"
                        unit="%"
                        description="TWA > 130° performance"
                        metric-id="vmgDownwind">
                    </metric-card>
                    
                    <metric-card 
                        title="Polar BSP"
                        :value="metrics.polarBsp"
                        unit="%"
                        description="60° ≤ TWA ≤ 130° performance"
                        metric-id="polarBsp">
                    </metric-card>
                </div>
            `,
            methods: {
                setupIntersectionObserver() {
                    const observer = new IntersectionObserver((entries) => {
                        entries.forEach((entry, index) => {
                            if (entry.isIntersecting) {
                                setTimeout(() => {
                                    this.animateMetricCard(entry.target);
                                }, index * 200);
                            }
                        });
                    }, {
                        threshold: 0.3,
                        rootMargin: '0px 0px -10% 0px'
                    });

                    this.$nextTick(() => {
                        const metricCards = this.$el.querySelectorAll('.metric-card');
                        metricCards.forEach(card => observer.observe(card));
                    });
                },
                animateMetricCard(card) {
                    const liquidElement = card.querySelector('.liquid-fill');
                    const metricId = card.querySelector('[class*="liquid-"]').className;
                    
                    const value = this.getValueForMetric(metricId);
                    if (value !== undefined) {
                        liquidElement.classList.add('animate');
                        
                        let colorClass = 'poor';
                        if (value >= 85) colorClass = 'excellent';
                        else if (value >= 70) colorClass = 'good';
                        else if (value >= 55) colorClass = 'fair';
                        
                        liquidElement.classList.add(colorClass);
                        
                        setTimeout(() => {
                            liquidElement.style.height = `${value}%`;
                        }, 100);
                    }
                },
                getValueForMetric(metricId) {
                    if (metricId.includes('efficiency')) return this.metrics.overallEfficiency;
                    if (metricId.includes('vmgUpwind')) return this.metrics.vmgUpwind;
                    if (metricId.includes('vmgDownwind')) return this.metrics.vmgDownwind;
                    if (metricId.includes('polarBsp')) return this.metrics.polarBsp;
                    return 0;
                }
            }
        };

        // Individual Metric Card Component
        const MetricCard = {
            props: ['title', 'value', 'unit', 'description', 'metricId'],
            template: `
                <div class="glass-card metric-card">
                    <div class="metric-title">{{ title }}</div>
                    <div class="liquid-bubble">
                        <div class="bubble-container">
                            <div :class="'liquid-fill liquid-' + metricId">
                                <div class="wave"></div>
                                <div class="wave"></div>
                                <div class="wave"></div>
                            </div>
                            <div class="bubble-glow"></div>
                        </div>
                    </div>
                    <div class="metric-value">{{ Math.round(value) }}</div>
                    <div class="metric-unit">{{ unit }}</div>
                    <div class="metric-description">{{ description }}</div>
                </div>
            `
        };

        // Login Modal Component
        const LoginModal = {
            emits: ['close', 'login'],
            data() {
                return {
                    username: '',
                    password: '',
                    isLoading: false
                };
            },
            template: `
                <div class="modal">
                    <div class="glass-card" style="
                        position: fixed;
                        top: 50%;
                        left: 50%;
                        transform: translate(-50%, -50%);
                        z-index: 1000;
                        width: 90%;
                        max-width: 400px;
                    ">
                        <h3 style="color: white; margin-bottom: 1rem;">🔐 Login to Racing System</h3>
                        
                        <div style="margin-bottom: 1rem;">
                            <label style="color: rgba(255,255,255,0.8); display: block; margin-bottom: 0.5rem;">
                                Username
                            </label>
                            <input 
                                type="text" 
                                v-model="username" 
                                placeholder="Enter username" 
                                style="
                                    width: 100%;
                                    padding: 0.75rem;
                                    border-radius: 10px;
                                    border: 1px solid rgba(255,255,255,0.3);
                                    background: rgba(255,255,255,0.1);
                                    color: white;
                                    backdrop-filter: blur(10px);
                                ">
                        </div>
                        
                        <div style="margin-bottom: 1.5rem;">
                            <label style="color: rgba(255,255,255,0.8); display: block; margin-bottom: 0.5rem;">
                                Password
                            </label>
                            <input 
                                type="password" 
                                v-model="password" 
                                placeholder="Enter password" 
                                @keyup.enter="attemptLogin"
                                style="
                                    width: 100%;
                                    padding: 0.75rem;
                                    border-radius: 10px;
                                    border: 1px solid rgba(255,255,255,0.3);
                                    background: rgba(255,255,255,0.1);
                                    color: white;
                                    backdrop-filter: blur(10px);
                                ">
                        </div>
                        
                        <div style="text-align: center; margin: 1.5rem 0;">
                            <button @click="attemptLogin" :disabled="isLoading" class="btn" style="margin-right: 1rem;">
                                {{ isLoading ? 'Authenticating...' : 'Login' }}
                            </button>
                            <button @click="$emit('close')" class="btn btn-secondary">Cancel</button>
                        </div>
                        
                        <div style="margin-top: 1rem; padding: 1rem; background: rgba(79, 172, 254, 0.1); border-radius: 8px;">
                            <div style="color: rgba(79, 172, 254, 1); font-size: 0.8rem; font-weight: bold;">
                                🔒 Secure login using Vercel environment variables
                            </div>
                        </div>
                    </div>
                    <div class="api-modal-backdrop" @click="$emit('close')" style="
                        position: fixed;
                        top: 0;
                        left: 0;
                        width: 100%;
                        height: 100%;
                        background: rgba(0,0,0,0.5);
                        backdrop-filter: blur(5px);
                        z-index: 999;
                    "></div>
                </div>
            `,
            methods: {
                async attemptLogin() {
                    if (!this.username.trim() || !this.password.trim()) {
                        alert('Please enter both username and password');
                        return;
                    }
                    
                    this.isLoading = true;
                    
                    try {
                        const response = await fetch('/api/auth', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                            },
                            body: JSON.stringify({ 
                                username: this.username, 
                                password: this.password 
                            })
                        });
                        
                        const result = await response.json();
                        
                        if (response.ok && result.success) {
                            this.$emit('login', {
                                username: result.username,
                                success: true
                            });
                        } else {
                            alert(result.message || 'Invalid credentials. Please try again.');
                        }
                    } catch (error) {
                        console.error('Login error:', error);
                        alert('Login failed. Please check your connection and try again.');
                    } finally {
                        this.isLoading = false;
                    }
                }
            }
        };

        // Config Modal Component
        const ConfigModal = {
            props: ['config'],
            emits: ['close', 'save', 'resetBackground'],
            data() {
                return {
                    formConfig: {
                        sailboatName: '',
                        boatClass: '',
                        ownerName: '',
                        sailNumber: ''
                    },
                    backgroundImage: null,
                    showPreview: false
                };
            },
            watch: {
                config: {
                    handler(newConfig) {
                        this.formConfig = { ...newConfig };
                        this.backgroundImage = newConfig.backgroundImage;
                        this.showPreview = !!newConfig.backgroundImage;
                    },
                    immediate: true
                }
            },
            template: `
                <div class="modal">
                    <div class="glass-card" style="
                        position: fixed;
                        top: 50%;
                        left: 50%;
                        transform: translate(-50%, -50%);
                        z-index: 1000;
                        width: 90%;
                        max-width: 700px;
                        max-height: 80vh;
                        overflow-y: auto;
                    ">
                        <h3 style="color: white; margin-bottom: 1.5rem;">⚙️ Sailboat Configuration</h3>
                        
                        <!-- Basic Configuration -->
                        <div style="margin-bottom: 2rem;">
                            <h4 style="color: rgba(255,255,255,0.9); font-size: 0.95rem; margin-bottom: 1rem; border-bottom: 1px solid rgba(255,255,255,0.2); padding-bottom: 0.5rem;">
                                Basic Information
                            </h4>
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 1rem;">
                                <div>
                                    <label style="color: rgba(255,255,255,0.8); display: block; margin-bottom: 0.5rem; font-size: 0.9rem;">
                                        Boat Name *
                                    </label>
                                    <input type="text" v-model="formConfig.sailboatName" placeholder="Enter boat name" style="
                                        width: 100%;
                                        padding: 0.75rem;
                                        border-radius: 10px;
                                        border: 1px solid rgba(255,255,255,0.3);
                                        background: rgba(255,255,255,0.1);
                                        color: white;
                                        backdrop-filter: blur(10px);
                                    ">
                                </div>
                                <div>
                                    <label style="color: rgba(255,255,255,0.8); display: block; margin-bottom: 0.5rem; font-size: 0.9rem;">
                                        Boat Class *
                                    </label>
                                    <input type="text" v-model="formConfig.boatClass" placeholder="e.g., ORC International" style="
                                        width: 100%;
                                        padding: 0.75rem;
                                        border-radius: 10px;
                                        border: 1px solid rgba(255,255,255,0.3);
                                        background: rgba(255,255,255,0.1);
                                        color: white;
                                        backdrop-filter: blur(10px);
                                    ">
                                </div>
                            </div>
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                                <div>
                                    <label style="color: rgba(255,255,255,0.8); display: block; margin-bottom: 0.5rem; font-size: 0.9rem;">
                                        Owner Name (Optional)
                                    </label>
                                    <input type="text" v-model="formConfig.ownerName" placeholder="Owner name" style="
                                        width: 100%;
                                        padding: 0.75rem;
                                        border-radius: 10px;
                                        border: 1px solid rgba(255,255,255,0.3);
                                        background: rgba(255,255,255,0.1);
                                        color: white;
                                        backdrop-filter: blur(10px);
                                    ">
                                </div>
                                <div>
                                    <label style="color: rgba(255,255,255,0.8); display: block; margin-bottom: 0.5rem; font-size: 0.9rem;">
                                        Sail Number (Optional)
                                    </label>
                                    <input type="text" v-model="formConfig.sailNumber" placeholder="Sail number" style="
                                        width: 100%;
                                        padding: 0.75rem;
                                        border-radius: 10px;
                                        border: 1px solid rgba(255,255,255,0.3);
                                        background: rgba(255,255,255,0.1);
                                        color: white;
                                        backdrop-filter: blur(10px);
                                    ">
                                </div>
                            </div>
                        </div>

                        <!-- Background Image Configuration -->
                        <div style="margin-bottom: 2rem;">
                            <h4 style="color: rgba(255,255,255,0.9); font-size: 0.95rem; margin-bottom: 1rem; border-bottom: 1px solid rgba(255,255,255,0.2); padding-bottom: 0.5rem;">
                                Background Image
                            </h4>
                            
                            <div v-if="showPreview" style="
                                width: 100%;
                                height: 120px;
                                border-radius: 12px;
                                background-size: cover;
                                background-position: center;
                                border: 2px solid rgba(255,255,255,0.3);
                                margin-bottom: 1rem;
                                position: relative;
                                overflow: hidden;
                                background-image: url(&quot; + backgroundImage + &quot;);
                            ">
                                <div style="
                                    position: absolute;
                                    bottom: 0;
                                    left: 0;
                                    right: 0;
                                    background: linear-gradient(transparent, rgba(0,0,0,0.7));
                                    padding: 0.75rem;
                                    color: white;
                                    font-size: 0.8rem;
                                ">
                                    Current Background
                                </div>
                            </div>

                            <div @click="triggerBackgroundInput" style="
                                border: 2px dashed rgba(255, 255, 255, 0.3);
                                border-radius: 12px;
                                padding: 1.5rem;
                                text-align: center;
                                cursor: pointer;
                                transition: all 0.3s ease;
                                background: rgba(255, 255, 255, 0.05);
                                margin-bottom: 1rem;
                            ">
                                <div style="font-size: 1.2rem; color: rgba(255, 255, 255, 0.6); margin-bottom: 0.5rem;">🖼️</div>
                                <div style="color: white; font-size: 0.95rem; margin-bottom: 0.25rem;">Upload Background Image</div>
                                <div style="color: rgba(255, 255, 255, 0.6); font-size: 0.8rem;">
                                    Click to select a background image for your dashboard<br>
                                    <span style="font-size: 0.75rem; color: rgba(255, 255, 255, 0.5);">Recommended: High resolution sailing/ocean images (JPG, PNG)</span>
                                </div>
                            </div>
                            
                            <input ref="backgroundInput" type="file" accept="image/*" @change="handleBackgroundUpload" style="display: none;">
                            
                            <div style="display: flex; gap: 0.75rem; justify-content: center;">
                                <button @click="$emit('resetBackground')" style="
                                    background: rgba(255, 140, 66, 0.8);
                                    border: none;
                                    padding: 0.5rem 1rem;
                                    border-radius: 15px;
                                    color: white;
                                    cursor: pointer;
                                    font-size: 0.8rem;
                                    transition: all 0.3s ease;
                                ">Reset to Default</button>
                            </div>
                        </div>
                        
                        <div style="text-align: center; margin: 2rem 0;">
                            <button @click="save" class="btn" style="margin-right: 1rem;">
                                Save Configuration
                            </button>
                            <button @click="$emit('close')" class="btn btn-secondary">Cancel</button>
                        </div>
                    </div>
                    <div class="api-modal-backdrop" @click="$emit('close')" style="
                        position: fixed;
                        top: 0;
                        left: 0;
                        width: 100%;
                        height: 100%;
                        background: rgba(0,0,0,0.5);
                        backdrop-filter: blur(5px);
                        z-index: 999;
                    "></div>
                </div>
            `,
            methods: {
                triggerBackgroundInput() {
                    this.$refs.backgroundInput.click();
                },
                async handleBackgroundUpload(event) {
                    const file = event.target.files[0];
                    if (!file) return;
                    
                    if (!file.type.startsWith('image/')) {
                        alert('Please select a valid image file (JPG, PNG, GIF, etc.)');
                        return;
                    }
                    
                    const maxSize = 5 * 1024 * 1024;
                    if (file.size > maxSize) {
                        alert('Image file is too large. Please choose an image smaller than 5MB.');
                        return;
                    }
                    
                    try {
                        const base64 = await this.fileToBase64(file);
                        this.backgroundImage = base64;
                        this.showPreview = true;
                    } catch (error) {
                        console.error('Error processing background image:', error);
                        alert('Error processing the image. Please try a different file.');
                    }
                },
                fileToBase64(file) {
                    return new Promise((resolve, reject) => {
                        const reader = new FileReader();
                        reader.onload = () => resolve(reader.result);
                        reader.onerror = reject;
                        reader.readAsDataURL(file);
                    });
                },
                save() {
                    const configToSave = {
                        ...this.formConfig,
                        sailboatName: this.formConfig.sailboatName.trim().toUpperCase() || 'BURRASCA',
                        boatClass: this.formConfig.boatClass.trim() || 'ORC International',
                        backgroundImage: this.backgroundImage
                    };
                    this.$emit('save', configToSave);
                }
            }
        };

        // API Config Modal Component
        const ApiConfigModal = {
            emits: ['close'],
            template: `
                <div class="modal">
                    <div class="glass-card" style="
                        position: fixed;
                        top: 50%;
                        left: 50%;
                        transform: translate(-50%, -50%);
                        z-index: 1000;
                        width: 90%;
                        max-width: 600px;
                        max-height: 80vh;
                        overflow-y: auto;
                    ">
                        <h3 style="color: white; margin-bottom: 1rem;">🔗 SailingPerformance WebReports Integration</h3>
                        
                        <div style="margin-bottom: 1.5rem; padding: 1rem; background: rgba(255,255,255,0.05); border-radius: 10px;">
                            <div style="color: rgba(255,255,255,0.9); font-size: 0.9rem; line-height: 1.5;">
                                <strong>📊 Detected System:</strong> kndwebreport.azurewebsites.net<br>
                                <strong>🏁 Your Report:</strong> Project 56, Regatta 302, Race 940
                            </div>
                        </div>
                        
                        <div style="text-align: center; margin: 1.5rem 0;">
                            <button @click="openReportInNewTab" class="btn" style="margin-right: 0.5rem;">🔗 Open WebReport</button>
                            <button @click="copyApiUrl" class="btn" style="background: rgba(255, 212, 59, 0.8); margin-right: 0.5rem;">📋 Copy URL</button>
                            <button @click="suggestDataExtraction" class="btn" style="background: rgba(81, 207, 102, 0.8); margin-right: 0.5rem;">💡 How to Extract Data</button>
                            <button @click="$emit('close')" class="btn btn-secondary">Close</button>
                        </div>
                        
                        <div style="margin-top: 1rem; padding: 1.5rem; background: rgba(255,255,255,0.05); border-radius: 10px;">
                            <div style="color: rgba(255,255,255,0.9); font-size: 0.85rem; line-height: 1.5;">
                                <strong>🔐 Secure Integration Options:</strong><br><br>
                                
                                <strong>Option 1: Export Data</strong><br>
                                • Log into your WebReports system<br>
                                • Export performance data as CSV/JSON<br>
                                • Upload to this dashboard<br><br>
                                
                                <strong>Option 2: Request API Access</strong><br>
                                • Contact <a href="mailto:info@sailingperformance.com" style="color: #4facfe;">info@sailingperformance.com</a><br>
                                • Ask about REST API endpoints for WebReports<br>
                                • Request authentication tokens (not passwords)<br><br>
                                
                                <strong>Option 3: Browser Extension</strong><br>
                                • Create a browser script to extract data<br>
                                • Use developer tools to identify data endpoints<br>
                                • Automate data copying from your logged-in session
                            </div>
                        </div>
                    </div>
                    <div class="api-modal-backdrop" @click="$emit('close')" style="
                        position: fixed;
                        top: 0;
                        left: 0;
                        width: 100%;
                        height: 100%;
                        background: rgba(0,0,0,0.5);
                        backdrop-filter: blur(5px);
                        z-index: 999;
                    "></div>
                </div>
            `,
            methods: {
                openReportInNewTab() {
                    const url = `https://kndwebreport.azurewebsites.net/Reports/View?idProject=56&idRegatta=302&idRaceReport=940&tab=0`;
                    window.open(url, '_blank');
                },
                copyApiUrl() {
                    const url = `https://kndwebreport.azurewebsites.net/Reports/View?idProject=56&idRegatta=302&idRaceReport=940&tab=0`;
                    
                    navigator.clipboard.writeText(url).then(() => {
                        alert('URL copied to clipboard!');
                    }).catch(() => {
                        const textArea = document.createElement('textarea');
                        textArea.value = url;
                        document.body.appendChild(textArea);
                        textArea.select();
                        document.execCommand('copy');
                        document.body.removeChild(textArea);
                        alert('URL copied to clipboard!');
                    });
                },
                suggestDataExtraction() {
                    const suggestions = `Data Extraction Options:

1. Manual Export:
   - Log into your WebReports
   - Export performance data as CSV/JSON
   - Upload to this dashboard

2. Browser Developer Tools:
   - Press F12 while logged into WebReports
   - Go to Network tab
   - Navigate through your reports
   - Look for API calls containing JSON data
   - Copy the data URLs for potential automation

3. Contact SailingPerformance:
   - Email: info@sailingperformance.com
   - Ask about API access for WebReports
   - Request JSON/REST endpoints
   - Mention you want to build custom dashboards

Would you like detailed instructions for any of these approaches?`;
                    
                    alert(suggestions);
                }
            }
        };

        // Main Vue Application
        const app = createApp({
            components: {
                LoginConfigCard,
                RacingResultsCard,
                FileUploadCard,
                DataPreviewCard,
                MetricsContainer,
                MetricCard,
                LoginModal,
                ConfigModal,
                ApiConfigModal
            },
            data() {
                return {
                    config: {
                        sailboatName: 'BURRASCA',
                        displayName: 'BURRASCA Performance Dashboard',
                        ownerName: '',
                        sailNumber: '',
                        boatClass: 'ORC International',
                        backgroundImage: null
                    },
                    loginState: {
                        isLoggedIn: false,
                        username: '',
                        lastLoginTime: null
                    },
                    modals: {
                        showLogin: false,
                        showConfig: false,
                        showApiConfig: false
                    },
                    data: [],
                    metrics: null,
                    raceData: {
                        eventName: "Andros 2025",
                        location: "Greek Islands", 
                        dates: "August 28-31, 2025",
                        className: "ORC International",
                        overallStanding: {
                            position: 0,
                            totalPoints: 0.0,
                            netPoints: 0.0,
                            className: "ORC International",
                            totalRaces: 1,
                            completedRaces: 0,
                            status: 'Event Pending'
                        }
                    },
                    lastUpdateTime: 'Just now',
                    isLoading: false,
                    errorMessage: ''
                };
            },
            mounted() {
                this.loadConfiguration();
                this.updateLastRefreshTime();
                this.startAutoRefresh();
            },
            methods: {
                // Configuration Management
                loadConfiguration() {
                    const savedConfig = localStorage.getItem('sailboat_config');
                    if (savedConfig) {
                        try {
                            const config = JSON.parse(savedConfig);
                            this.config = { ...this.config, ...config };
                        } catch (e) {
                            console.log('Using default configuration');
                        }
                    }

                    const savedLoginState = localStorage.getItem('login_state');
                    if (savedLoginState) {
                        try {
                            this.loginState = { ...this.loginState, ...JSON.parse(savedLoginState) };
                        } catch (e) {
                            console.log('Using default login state');
                        }
                    }

                    this.applyStoredBackground();
                },

                applyStoredBackground() {
                    if (this.config.backgroundImage) {
                        document.body.style.backgroundImage = `url(${this.config.backgroundImage})`;
                    }
                },

                resetBackground() {
                    this.config.backgroundImage = null;
                    document.body.style.backgroundImage = '';
                    localStorage.setItem('sailboat_config', JSON.stringify(this.config));
                },

                saveConfiguration(newConfig) {
                    this.config = { ...this.config, ...newConfig };
                    this.config.displayName = `${this.config.sailboatName} Performance Dashboard`;
                    
                    if (this.config.backgroundImage) {
                        document.body.style.backgroundImage = `url(${this.config.backgroundImage})`;
                    }
                    
                    localStorage.setItem('sailboat_config', JSON.stringify(this.config));
                    this.closeConfigModal();
                    
                    // Update page title
                    document.title = `${this.config.sailboatName} - Sailing Performance Dashboard`;
                },

                // Authentication
                showLoginModal() {
                    this.modals.showLogin = true;
                    document.body.style.overflow = 'hidden';
                },

                closeLoginModal() {
                    this.modals.showLogin = false;
                    document.body.style.overflow = 'auto';
                },

                async attemptLogin(loginData) {
                    if (loginData.success) {
                        this.loginState = {
                            isLoggedIn: true,
                            username: loginData.username,
                            lastLoginTime: new Date().toISOString()
                        };
                        
                        localStorage.setItem('login_state', JSON.stringify(this.loginState));
                        this.closeLoginModal();
                        alert(`Login successful! You can now configure your sailboat settings.`);
                    }
                },

                logout() {
                    this.loginState = {
                        isLoggedIn: false,
                        username: '',
                        lastLoginTime: null
                    };
                    
                    localStorage.removeItem('login_state');
                    alert('Logged out successfully. Configuration is now locked.');
                },

                // Quick Configuration
                saveQuickConfig(quickConfig) {
                    if (!this.loginState.isLoggedIn) {
                        alert('Please login first to modify configuration');
                        return;
                    }

                    if (!quickConfig.sailboatName) {
                        alert('Boat name is required');
                        return;
                    }

                    if (!quickConfig.boatClass) {
                        alert('Boat class is required');
                        return;
                    }

                    this.config.sailboatName = quickConfig.sailboatName;
                    this.config.boatClass = quickConfig.boatClass;
                    this.config.displayName = `${quickConfig.sailboatName} Performance Dashboard`;
                    
                    localStorage.setItem('sailboat_config', JSON.stringify(this.config));
                    
                    // Update page title
                    document.title = `${this.config.sailboatName} - Sailing Performance Dashboard`;
                },

                // Modal Management
                showConfigModal() {
                    if (!this.loginState.isLoggedIn) {
                        alert('Please login first to access advanced configuration');
                        return;
                    }
                    
                    this.modals.showConfig = true;
                    document.body.style.overflow = 'hidden';
                },

                closeConfigModal() {
                    this.modals.showConfig = false;
                    document.body.style.overflow = 'auto';
                },

                showApiConfig() {
                    this.modals.showApiConfig = true;
                    document.body.style.overflow = 'hidden';
                },

                closeApiConfig() {
                    this.modals.showApiConfig = false;
                    document.body.style.overflow = 'auto';
                },

                // File Upload
                async handleFileUpload(file) {
                    this.isLoading = true;
                    this.errorMessage = '';
                    
                    try {
                        const text = await this.readFileAsText(file);
                        this.data = this.parseLogData(text);
                        
                        if (this.data.length === 0) {
                            throw new Error('No valid data found in file');
                        }
                        
                        this.calculateAndDisplayMetrics();
                        
                    } catch (error) {
                        this.errorMessage = `Error processing file: ${error.message}`;
                    } finally {
                        this.isLoading = false;
                    }
                },

                readFileAsText(file) {
                    return new Promise((resolve, reject) => {
                        const reader = new FileReader();
                        reader.onload = (e) => resolve(e.target.result);
                        reader.onerror = (e) => reject(new Error('Failed to read file'));
                        reader.readAsText(file);
                    });
                },

                parseLogData(text) {
                    const lines = text.split('\n');
                    const data = [];
                    
                    for (let i = 1; i < lines.length; i++) {
                        const line = lines[i].trim();
                        if (!line) continue;
                        
                        const parts = line.split(/[,\t]/);
                        
                        if (parts.length >= 6) {
                            const record = {
                                timestamp: parts[0],
                                boatSpeed: this.parseNumber(parts[1]),
                                trueWindAngle: this.parseNumber(parts[2]),
                                trueWindSpeed: this.parseNumber(parts[3]),
                                courseOverGround: this.parseNumber(parts[4]),
                                speedOverGround: this.parseNumber(parts[5]),
                                polarSpeed: this.calculatePolarSpeed(this.parseNumber(parts[3]), this.parseNumber(parts[2]))
                            };
                            
                            if (this.isValidRecord(record)) {
                                data.push(record);
                            }
                        }
                    }
                    
                    if (data.length === 0) {
                        return this.generateSampleData();
                    }
                    
                    return data;
                },

                generateSampleData() {
                    const sampleData = [];
                    for (let i = 0; i < 100; i++) {
                        const twa = Math.random() * 180;
                        const tws = 8 + Math.random() * 12;
                        const polarSpeed = this.calculatePolarSpeed(tws, twa);
                        const actualSpeed = polarSpeed * (0.75 + Math.random() * 0.4);
                        
                        sampleData.push({
                            timestamp: new Date(Date.now() - (100 - i) * 60000).toISOString(),
                            boatSpeed: actualSpeed,
                            trueWindAngle: twa,
                            trueWindSpeed: tws,
                            courseOverGround: Math.random() * 360,
                            speedOverGround: actualSpeed * (0.9 + Math.random() * 0.2),
                            polarSpeed: polarSpeed
                        });
                    }
                    return sampleData;
                },

                calculatePolarSpeed(tws, twa) {
                    const normalizedTWA = Math.abs(twa);
                    let efficiency = 1.0;
                    
                    if (normalizedTWA < 40) efficiency = 0.6;
                    else if (normalizedTWA < 60) efficiency = 0.8;
                    else if (normalizedTWA < 90) efficiency = 1.0;
                    else if (normalizedTWA < 120) efficiency = 0.9;
                    else if (normalizedTWA < 150) efficiency = 0.8;
                    else efficiency = 0.7;
                    
                    return tws * 0.5 * efficiency;
                },

                parseNumber(str) {
                    const num = parseFloat(str);
                    return isNaN(num) ? 0 : num;
                },

                isValidRecord(record) {
                    return record.boatSpeed > 0 && 
                           record.trueWindSpeed > 0 && 
                           record.trueWindAngle >= 0 && 
                           record.trueWindAngle <= 180;
                },

                calculateAndDisplayMetrics() {
                    this.metrics = this.calculatePerformanceMetrics();
                },

                calculatePerformanceMetrics() {
                    const upwindData = this.data.filter(r => r.trueWindAngle < 60);
                    const downwindData = this.data.filter(r => r.trueWindAngle > 130);
                    const reachingData = this.data.filter(r => r.trueWindAngle >= 60 && r.trueWindAngle <= 130);
                    
                    const overallEfficiency = this.data.reduce((sum, r) => 
                        sum + (r.boatSpeed / r.polarSpeed * 100), 0) / this.data.length;
                    
                    const vmgUpwind = upwindData.length > 0 ? 
                        upwindData.reduce((sum, r) => {
                            const vmg = r.boatSpeed * Math.cos(r.trueWindAngle * Math.PI / 180);
                            const polarVmg = r.polarSpeed * Math.cos(r.trueWindAngle * Math.PI / 180);
                            return sum + (vmg / polarVmg * 100);
                        }, 0) / upwindData.length : 0;
                    
                    const vmgDownwind = downwindData.length > 0 ?
                        downwindData.reduce((sum, r) => {
                            const vmg = r.boatSpeed * Math.cos((180 - r.trueWindAngle) * Math.PI / 180);
                            const polarVmg = r.polarSpeed * Math.cos((180 - r.trueWindAngle) * Math.PI / 180);
                            return sum + (vmg / polarVmg * 100);
                        }, 0) / downwindData.length : 0;
                    
                    const polarBsp = reachingData.length > 0 ?
                        reachingData.reduce((sum, r) => 
                            sum + (r.boatSpeed / r.polarSpeed * 100), 0) / reachingData.length : 0;
                    
                    return {
                        overallEfficiency: Math.max(0, Math.min(100, overallEfficiency)),
                        vmgUpwind: Math.max(0, Math.min(100, vmgUpwind)),
                        vmgDownwind: Math.max(0, Math.min(100, vmgDownwind)),
                        polarBsp: Math.max(0, Math.min(100, polarBsp))
                    };
                },

                // Race Results
                async manualRefreshResults() {
                    // Simulate race results refresh
                    try {
                        const success = await this.fetchLiveRaceResults();
                        if (success) {
                            this.updateLastRefreshTime();
                        }
                    } catch (error) {
                        console.error('Error refreshing results:', error);
                    }
                },

                async fetchLiveRaceResults() {
                    // Simulate API call - in real implementation this would call your race results API
                    return new Promise((resolve) => {
                        setTimeout(() => {
                            console.log('Simulated race results fetch');
                            resolve(false); // No new results for demo
                        }, 1000);
                    });
                },

                startAutoRefresh() {
                    // Update time display every 30 seconds
                    setInterval(() => {
                        this.updateLastRefreshTime();
                    }, 30000);
                    
                    this.updateLastRefreshTime();
                },

                updateLastRefreshTime() {
                    const now = new Date();
                    this.lastUpdateTime = now.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
                }
            }
        });

        app.mount('#app');
    </script>
</body>
</html>
